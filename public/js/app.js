var o={login:"Masuk",register:"Daftar",logout:"Keluar",email:"Email",phoneNumber:"Nomor HP",password:"Kata Sandi",fullName:"Nama Lengkap",dashboard:"Dashboard",submit:"Input Data",admin:"Admin Panel",save:"Simpan",cancel:"Batal",edit:"Ubah",delete:"Hapus",back:"Kembali",areaSetting:"Pengaturan Area",currentArea:"Area Saat Ini",editArea:"Ubah Area",province:"Provinsi",kabupatenKota:"Kabupaten/Kota",selectProvince:"Pilih Provinsi",selectKabupaten:"Pilih Kabupaten/Kota",calegSetting:"Pengaturan Caleg",calegName:"Nama Caleg",currentCaleg:"Caleg Saat Ini",editCaleg:"Ubah Caleg",tps:"TPS",village:"Desa/Kelurahan",district:"Kecamatan",totalVotes:"Total Suara",calegVotes:"Suara Caleg",photo:"Foto C1",location:"Lokasi",saveError:"Gagal menyimpan",saveSuccess:"Berhasil disimpan",loginError:"Login gagal",registerSuccess:"Pendaftaran berhasil",loading:"Memuat...",unverifiedUsers:"Pengguna Belum Terverifikasi",verify:"Verifikasi",submissions:"Data Masuk",approve:"Setujui",flag:"Tandai",export:"Ekspor CSV"};var g={email:"",password:"",loading:!1,error:"",login(){this.loading=!0,this.error="";let e={email:this.email,password:this.password};console.log("[FRONTEND LOGIN] Sending body:",e),m.request({method:"POST",url:"/api/login",body:e,headers:{"Content-Type":"application/json"}}).then(t=>{localStorage.setItem("token",t.token),localStorage.setItem("user",JSON.stringify(t.user)),m.route.set("/app/dashboard")}).catch(t=>{this.error=t.error||o.loginError,this.loading=!1,m.redraw()})},view(){return m("main.container",[m("h1",o.login),m("form",{onsubmit:e=>{e.preventDefault(),this.login()}},[m("label",{for:"email"},o.email||"Email"),m("input",{id:"email",type:"email",value:this.email,oninput:e=>{this.email=e.target.value},required:!0}),m("label",{for:"password"},o.password),m("input",{id:"password",type:"password",value:this.password,oninput:e=>{this.password=e.target.value},required:!0}),m("button[type=submit]",{disabled:this.loading},o.login),this.error&&m("div.error",this.error)]),m("p",["Belum punya akun? ",m("a",{href:"#!/app/register"},o.register)])])}};var f={fullName:"",email:"",phoneNumber:"",password:"",loading:!1,error:"",success:"",register(){if(!this.fullName||!this.email||!this.phoneNumber||!this.password){this.error="Semua field wajib diisi";return}this.loading=!0,this.error="",this.success="",m.request({method:"POST",url:"/api/register",body:{fullName:this.fullName,email:this.email,phoneNumber:this.phoneNumber,password:this.password},headers:{"Content-Type":"application/json"}}).then(e=>{this.success=e.message||o.registerSuccess,this.fullName="",this.email="",this.phoneNumber="",this.password="",this.loading=!1,m.redraw()}).catch(e=>{this.error=e.error||"Pendaftaran gagal",this.loading=!1,m.redraw()})},view(){return m("main.container",[m("h1",o.register),m("form",{onsubmit:e=>{e.preventDefault(),this.register()}},[m("label",{for:"fullName"},o.fullName),m("input",{id:"fullName",type:"text",value:this.fullName,oninput:e=>{this.fullName=e.target.value},required:!0}),m("label",{for:"email"},o.email),m("input",{id:"email",type:"email",value:this.email,oninput:e=>{this.email=e.target.value},required:!0}),m("label",{for:"phoneNumber"},o.phoneNumber),m("input",{id:"phoneNumber",type:"tel",value:this.phoneNumber,oninput:e=>{this.phoneNumber=e.target.value},required:!0}),m("label",{for:"password"},o.password),m("input",{id:"password",type:"password",value:this.password,oninput:e=>{this.password=e.target.value},required:!0}),m("button[type=submit]",{disabled:this.loading},o.register),this.success&&m("div.success",this.success),this.error&&m("div.error",this.error)]),m("p",["Sudah punya akun? ",m("a",{href:"#!/app/login"},o.login)])])}};var c={tps:"",village:"",district:"",totalVotes:"",calegVotes:"",photo:null,latitude:"",longitude:"",provinsiCode:"",kabupatenKotaCode:"",kecamatanCode:"",kelurahanDesaCode:"",loading:!1,error:"",success:"",photoPreview:null,hideFields:[],editMode:!1,submissionId:null,prefillData:null,areaData:{kecamatanList:[],desaList:[]},photoBase64:null,photoMime:null,photoProcessing:!1,photoChanged:!1,hasExistingPhoto:!1,async oninit(e){this.onsuccess=e.attrs.onsuccess,this.hideFields=e.attrs.hideFields||[],this.areaData=e.attrs.areaData||{kecamatanList:[],desaList:[]},e.attrs.submission?(this.editMode=!0,this.submissionId=e.attrs.submission._id,this.populateForm(e.attrs.submission)):e.attrs.id?(this.editMode=!0,this.submissionId=e.attrs.id,await this.fetchSubmissionData()):e.attrs.prefill&&(this.prefillData=e.attrs.prefill,this.village=e.attrs.prefill.village||"",this.district=e.attrs.prefill.district||"",this.provinsiCode=e.attrs.prefill.provinsiCode||"",this.kabupatenKotaCode=e.attrs.prefill.kabupatenKotaCode||"",this.kecamatanCode=e.attrs.prefill.kecamatanCode||"",this.kelurahanDesaCode=e.attrs.prefill.kelurahanDesaCode||"",this.tps=e.attrs.prefill.tps||"")},onupdate(e){e.attrs.submission&&e.attrs.submission._id!==this.submissionId&&(this.editMode=!0,this.submissionId=e.attrs.submission._id,this.areaData=e.attrs.areaData||{kecamatanList:[],desaList:[]},this.populateForm(e.attrs.submission),m.redraw())},populateForm(e){console.log("SubmissionForm: populateForm called with:",e),this.photoChanged=!1,this.photoBase64=null,this.photoMime=null,this.photo=null,this.hasExistingPhoto=!1,this.tps=e.tps||e.tpsNumber||"",this.totalVotes=e.totalVotes||e.votes||"",this.calegVotes=e.calegVotes||"",e.location&&e.location.coordinates&&e.location.coordinates.length===2?(this.longitude=e.location.coordinates[0],this.latitude=e.location.coordinates[1]):e.latitude&&e.longitude&&(this.latitude=e.latitude,this.longitude=e.longitude),this.provinsiCode=e.provinsiCode||"",this.kabupatenKotaCode=e.kabupatenKotaCode||"",this.kecamatanCode=e.kecamatanCode||"",this.kelurahanDesaCode=e.kelurahanDesaCode||"";let t=this.areaData.kecamatanList.find(i=>i.code===this.kecamatanCode);this.district=t?.name||e.district||this.kecamatanCode||"N/A";let a=this.areaData.desaList.find(i=>i.code===this.kelurahanDesaCode);this.village=a?.name||e.village||this.kelurahanDesaCode||"N/A",e.hasPhoto||e.photo||e.photoMime?(this.hasExistingPhoto=!0,this.photoPreview=`/api/photo/${e._id||this.submissionId}?t=${Date.now()}`,console.log("SubmissionForm: Set photo preview:",this.photoPreview)):(this.hasExistingPhoto=!1,this.photoPreview=null),m.redraw()},async fetchSubmissionData(){try{this.loading=!0;let e=await m.request({method:"GET",url:`/api/submissions/${this.submissionId}`,headers:{Authorization:"Bearer "+localStorage.getItem("token")}});e&&this.populateForm(e)}catch(e){console.error("Error fetching submission data:",e),this.error="Gagal memuat data untuk diedit: "+(e.response?.error||e.message||"Unknown error")}finally{this.loading=!1,m.redraw()}},getLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{this.latitude=e.coords.latitude,this.longitude=e.coords.longitude,m.redraw()},e=>{console.error("Error getting location:",e)})},async handleFileUpload(e){let t=e.target.files[0];if(console.log("[PHOTO] File selected:",t?.name||"No file"),!t){this.photo=null,this.photoBase64=null,this.photoMime=null,this.photoProcessing=!1,this.photoChanged=!0,this.editMode&&(this.photoPreview=null,this.hasExistingPhoto=!1),m.redraw();return}this.photo=t,this.photoProcessing=!0,this.photoChanged=!0,this.photoBase64=null,this.photoPreview=URL.createObjectURL(t),m.redraw(),console.log("[PHOTO] Started Base64 conversion...");try{let a=await this.fileToBase64(t);this.photoBase64=a.split(",")[1],this.photoMime=t.type,this.photoProcessing=!1,console.log("[PHOTO] Base64 conversion completed"),m.redraw()}catch(a){console.error("[PHOTO] Conversion error:",a),this.error="Gagal memproses file gambar.",this.photo=null,this.photoBase64=null,this.photoProcessing=!1,this.photoChanged=!1,m.redraw()}},fileToBase64(e){return new Promise((t,a)=>{let i=new FileReader;i.readAsDataURL(e),i.onload=()=>t(i.result),i.onerror=s=>a(s)})},_validate(){if(!this.editMode&&!this.photo)return"Foto bukti wajib diunggah.";if(this.photo&&this.photoProcessing)return"Gambar masih diproses, mohon tunggu...";if(this.photo&&!this.photoBase64)return"Gambar gagal diproses. Silakan unggah ulang.";let e=parseInt(this.totalVotes,10)||0;return(parseInt(this.calegVotes,10)||0)>e?"Jumlah suara caleg tidak boleh melebihi total suara.":null},_buildPayload(){let e={tps:this.tps,totalVotes:parseInt(this.totalVotes,10)||0,calegVotes:parseInt(this.calegVotes,10)||0,provinsiCode:this.provinsiCode,kabupatenKotaCode:this.kabupatenKotaCode,kecamatanCode:this.kecamatanCode,kelurahanDesaCode:this.kelurahanDesaCode,latitude:this.latitude,longitude:this.longitude};return this.photoChanged&&(this.photoBase64?(e.photoBase64=`data:${this.photoMime};base64,${this.photoBase64}`,console.log("[SUBMIT] Including new photo in payload")):!this.photo&&this.editMode&&(e.removePhoto=!0,console.log("[SUBMIT] Removing photo in edit mode"))),e},_handleApiError(e){let t=e.response||e;if(t&&typeof t=="object"&&t.error){let a=t.error;if(t.details&&typeof t.details=="object"){let i=Object.values(t.details).map(s=>s.message).join(", ");i&&(a+=`: ${i}`)}return a}return this.editMode?"Gagal memperbarui data":"Gagal mengirim data"},_handleSuccess(){this.loading=!1,this.success=this.editMode?"Data berhasil diperbarui!":"Data berhasil dikirim!",this.editMode?(this.photoChanged=!1,(this.hasExistingPhoto||this.photoBase64)&&(this.photoPreview=`/api/photo/${this.submissionId}?t=${Date.now()}`)):this.resetForm(),this.onsuccess&&typeof this.onsuccess=="function"&&this.onsuccess(),m.redraw()},async submit(){this.loading=!0,this.error="",this.success="";let e=this._validate();if(e){this.error=e,this.loading=!1,m.redraw();return}try{let t=(this.editMode,"/api/submission"),a=this.editMode?"PUT":"POST",i=this._buildPayload();this.editMode&&(i.id=this.submissionId),await m.request({method:a,url:t,body:i,headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}}),await m.request({method:"POST",url:"/api/submission_detail",body:{id:this.submissionId},headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}}),this._handleSuccess()}catch(t){this.error=this._handleApiError(t),this.loading=!1,m.redraw()}},resetForm(){this.tps="",this.totalVotes="",this.calegVotes="",this.photo=null,this.photoBase64=null,this.photoPreview=null,this.photoMime=null,this.photoProcessing=!1,this.photoChanged=!1,this.hasExistingPhoto=!1,this.latitude="",this.longitude="";let e=document.querySelector("#photo");e&&(e.value="")},view(){return m("form",{onsubmit:e=>{e.preventDefault(),this.submit()}},[this.editMode&&m("div",{style:{marginBottom:"1rem",padding:"0.5rem",backgroundColor:"#e3f2fd",borderRadius:"4px",textAlign:"center"}},[m("strong","Mode Edit - Memperbarui data submission")]),!this.hideFields.includes("village")&&[m("label",{for:"village"},o.village),m("input",{id:"village",type:"text",value:this.village,disabled:!0,required:!0})],!this.hideFields.includes("district")&&[m("label",{for:"district"},o.district),m("input",{id:"district",type:"text",value:this.district,disabled:!0,required:!0})],m("label",{for:"tps"},o.tps),m("input",{id:"tps",type:"text",value:this.tps,oninput:e=>{this.tps=e.target.value},required:!0}),m("label",{for:"totalVotes"},o.totalVotes),m("input",{id:"totalVotes",type:"number",value:this.totalVotes,oninput:e=>{this.totalVotes=e.target.value},required:!0}),m("label",{for:"calegVotes"},o.calegVotes),m("input",{id:"calegVotes",type:"number",value:this.calegVotes,oninput:e=>{this.calegVotes=e.target.value},required:!0}),m("label",{for:"photo"},o.photo+(this.editMode?" (Kosongkan jika tidak ingin mengubah)":"")),m("input",{id:"photo",type:"file",accept:"image/*",onchange:e=>this.handleFileUpload(e),required:!this.editMode}),this.editMode&&!this.photoChanged&&this.hasExistingPhoto&&m("div",{style:{marginTop:"0.5rem",padding:"0.5rem",backgroundColor:"#f5f5f5",borderRadius:"4px"}},[m("small","Foto saat ini:"),m("br"),m("img",{src:this.photoPreview,style:{maxWidth:"100px",maxHeight:"100px",marginTop:"0.5rem"},alt:"Foto saat ini",onerror:e=>{console.error("Failed to load existing photo"),e.target.style.display="none"}})]),this.photoPreview&&(this.photoChanged||!this.editMode)&&m("img",{src:this.photoPreview,style:{maxWidth:"100%",maxHeight:"200px",marginTop:"1rem",display:"block"},alt:"Pratinjau Foto"}),this.photoProcessing&&m("div",{style:{marginTop:"0.5rem",color:"#666"}},"Memproses gambar..."),m("div",[m("label","Lokasi GPS"),m("button",{type:"button",onclick:()=>this.getLocation()},"Dapatkan Lokasi"),this.latitude&&this.longitude&&m("p",`Lat: ${this.latitude}, Lng: ${this.longitude}`)]),m("button[type=submit]",{disabled:this.loading||this.photoProcessing},this.loading?this.editMode?"Memperbarui...":"Mengirim...":this.editMode?"Perbarui Data":o.submit),this.success&&m("div.success",this.success),this.error&&m("div.error",this.error)])}};var D=()=>{let e=localStorage.getItem("token");return e?{Authorization:`Bearer ${e}`}:{}},u=e=>{let a={...D(),...e.headers};return m.request({...e,headers:a})},h=()=>{localStorage.removeItem("token"),m.route.set("/app/login")};var b={cursor:"pointer",textAlign:"center",padding:"calc(var(--spacing) * 1.5)",display:"flex",alignItems:"center",justifyContent:"center",minHeight:"8rem"},y={margin:0,fontWeight:400},v={area:null,calegName:"",kecamatanList:[],desaList:[],selectedKecamatan:null,selectedDesa:null,loading:!0,loadingDesa:!1,loadingSubmissions:!1,userSubmissions:[],error:"",isModalOpen:!1,modalImageUrl:"",isEditModalOpen:!1,editingSubmissionId:null,async oninit(){this.loading=!0,this.error="";try{let[e,t]=await Promise.all([u({method:"GET",url:"/api/area-setting"}),u({method:"GET",url:"/api/caleg"}).catch(()=>({}))]);this.area=e,t&&t.name&&(this.calegName=t.name),this.area&&this.area.kabupatenKota&&this.area.provinsi&&this.calegName?this.kecamatanList=await u({method:"POST",url:"/api/kecamatan",body:{kabupatenCode:this.area.kabupatenKota,provinsiCode:this.area.provinsi},headers:{"Content-Type":"application/json"}}):this.kecamatanList=[]}catch(e){this.error=e.response?.error||"Gagal memuat data dasbor.",(e.code===401||e.code===403)&&h()}finally{this.loading=!1,m.redraw()}},async selectKecamatan(e){if(this.calegName){this.selectedKecamatan=e,this.desaList=[],this.loadingDesa=!0,this.error="",m.redraw();try{let{provinsi:t,kabupatenKota:a}=this.area;this.desaList=await u({method:"POST",url:"/api/kelurahan",body:{provinsiCode:t,kabupatenCode:a,kecamatanCode:e.code},headers:{"Content-Type":"application/json"}})}catch(t){this.error=t.response?.error||"Gagal memuat daftar desa.",(t.code===401||t.code===403)&&h()}finally{this.loadingDesa=!1,m.redraw()}}},async selectDesa(e){this.selectedDesa=e,this.fetchUserSubmissions(e.code)},async fetchUserSubmissions(e){console.log("fetchUserSubmissions called with desaCode:",e),console.log("selectedKecamatan:",this.selectedKecamatan),console.log("selectedDesa:",this.selectedDesa),this.loadingSubmissions=!0,this.userSubmissions=[],m.redraw();try{let t=await u({method:"POST",url:"/api/mysubs",body:{kelurahanDesaCode:e},headers:{"Content-Type":"application/json"}});this.userSubmissions=t||[],console.log("userSubmissions set to:",this.userSubmissions)}catch(t){console.error("Could not fetch user's submissions",t),console.error("Error details:",t.response),this.userSubmissions=[]}finally{this.loadingSubmissions=!1,m.redraw()}},fetchKecamatan(){return!this.area.kabupatenKota||!this.area.provinsi?Promise.resolve([]):m.request({method:"POST",url:"/api/kecamatan",body:{kabupatenCode:this.area.kabupatenKota,provinsiCode:this.area.provinsi},headers:{"Content-Type":"application/json"}})},fetchDesa(){return!this.area.kabupatenKota||!this.area.provinsi||!this.area.kecamatan?Promise.resolve([]):m.request({method:"POST",url:"/api/kelurahan",body:{provinsiCode:this.area.provinsi,kabupatenCode:this.area.kabupatenKota,kecamatanCode:this.area.kecamatan},headers:{"Content-Type":"application/json"}})},renderCalegInfoBox(){return this.calegName?m("div",{style:{marginBottom:"1rem",background:"#f5f5f5",padding:"0.75rem",borderRadius:"6px",textAlign:"center"}},m("strong",`Caleg: ${this.calegName}`)):null},renderEditModal(){return this.isEditModalOpen?m("dialog",{open:!0},[m("article",[m("header",[m("a.close",{href:"#","aria-label":"Close",onclick:e=>{e.preventDefault(),this.isEditModalOpen=!1,m.redraw()}})]),m("div","Edit form/modal content here...")])]):null},renderPhotoModal(){return this.isModalOpen?m("dialog",{open:!0},[m("article",[m("header",[m("a.close",{href:"#","aria-label":"Close",onclick:e=>{e.preventDefault(),this.isModalOpen=!1,m.redraw()}})]),m("div",{style:{textAlign:"center"}},[m("img",{src:this.modalImageUrl,style:{maxWidth:"100%",maxHeight:"70vh"},alt:"Bukti Foto",onerror:e=>{e.target.parentNode.innerHTML='<p class="error">Gagal memuat gambar</p>'}})])])]):null},openEditModal(e){this.isEditModalOpen=!0,this.editingSubmissionId=e,m.redraw()},async openPhotoModal(e,t=null){if(this.isModalOpen=!0,t)this.modalImageUrl=t;else{let a=await this.fetchPhotoData(e);this.modalImageUrl=a||`/api/submissions/photo/${e}`}m.redraw()},async fetchPhotoData(e){let a=await(await u({method:"POST",url:"/api/photo",body:{id:e},headers:{"Content-Type":"application/json"},extract:!0})).blob();return URL.createObjectURL(a)},view(){let t=JSON.parse(localStorage.getItem("user")||"{}").role==="admin";return this.loading?m("main.container",m("p",o.loading)):this.error&&!this.loadingDesa?m("main.container",[m("h2",o.dashboard),m("p.error",this.error),t&&m("button",{onclick:()=>{m.route.set("/app/admin")},style:{marginRight:"1rem"}},"Ke Halaman Admin"),m("button",{onclick:h},o.logout)]):!this.area||!this.area.kabupatenKota?m("main.container",[m("h2",o.dashboard),m("p","Area belum diatur oleh admin."),t&&m("button",{onclick:()=>{m.route.set("/app/admin")},style:{marginRight:"1rem"}},"Ke Halaman Admin"),m("button",{onclick:h},o.logout)]):this.selectedKecamatan&&this.selectedDesa?m("main.container",[m("h4",{style:{marginTop:"var(--spacing)"}},"Data Terkirim di Desa Ini"),this.loadingSubmissions?m("p",o.loading):this.userSubmissions.length>0?m("table",{role:"grid"},[m("thead",m("tr",[m("th","TPS"),m("th","Suara"),m("th","Foto"),m("th","GPS"),m("th","")])),m("tbody",this.userSubmissions.map(a=>m("tr",[m("td",a.tpsNumber),m("td",a.votes),m("td",m("div",{style:{width:"40px",height:"40px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},onclick:async()=>{let i=await this.fetchPhotoData(a._id);i?this.openPhotoModal(a._id,i):alert("Gagal memuat foto")}},a._id?m("img",{src:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",style:{maxHeight:"40px",maxWidth:"40px",display:"none"},alt:"Bukti Foto",oncreate:async i=>{let s=await this.fetchPhotoData(a._id);s?(i.dom.src=s,i.dom.style.display="block"):i.dom.parentNode.innerHTML="\u274C"}}):"\u274C")),m("td",a.hasLocation?"\u2705":"\u274C"),m("td",m("button",{class:"outline secondary",style:{margin:0,padding:"0.25rem 0.75rem",fontSize:"0.8rem",display:"flex",alignItems:"center",justifyContent:"center"},onclick:()=>this.openEditModal(a._id),title:"Edit"},"\u270F\uFE0F"))])))]):m("p","Belum ada data yang dikirim untuk desa ini."),m("hr"),m("h3",`Input Data untuk ${this.selectedDesa.name}`),this.calegName&&m("p",{style:{fontStyle:"italic",textAlign:"center",marginTop:"calc(var(--spacing) * -0.5)",marginBottom:"var(--spacing)"}},`(Suara untuk Caleg: ${this.calegName})`),m(c,{prefill:{village:this.selectedDesa.name,district:this.selectedKecamatan.name,provinsiCode:this.area.provinsi,kabupatenKotaCode:this.area.kabupatenKota,kecamatanCode:this.selectedKecamatan.code,kelurahanDesaCode:this.selectedDesa.code},onsuccess:()=>{console.log("SubmissionForm success callback called"),console.log("About to fetch submissions for desa code:",this.selectedDesa.code),setTimeout(()=>{this.fetchUserSubmissions(this.selectedDesa.code)},500)}}),m("footer",{style:{paddingTop:"var(--spacing)"}},m(".grid",m("button",{class:"secondary",onclick:()=>this.backToDesaList()},"Kembali ke Daftar Desa"),m("button",{class:"contrast",onclick:h},o.logout)),this.renderEditModal()),this.renderPhotoModal()]):this.selectedKecamatan?m("main.container",[m("h2",o.dashboard),this.renderCalegInfoBox(),m("h3",`Pilih Desa/Kelurahan di Kecamatan ${this.selectedKecamatan.name}`),this.loadingDesa?m("p",o.loading):m(".grid",{style:{gridTemplateColumns:"repeat(auto-fit, minmax(12rem, 1fr))"}},this.desaList.map(a=>m("article",{onclick:()=>this.selectDesa(a),style:b},m("h3",{style:y},a.name)))),this.error&&m("p.error",this.error),m("footer",{style:{paddingTop:"var(--spacing)"}},m(".grid",m("button",{class:"secondary",onclick:()=>this.backToKecamatanList()},"Kembali ke Daftar Kecamatan"),m("button",{class:"contrast",onclick:h},o.logout)))]):m("main.container",[m("h2",o.dashboard),this.renderCalegInfoBox(),m("h3","Pilih Kecamatan"),!this.calegName&&m("p",{style:{color:"var(--pico-color-red-500)",fontWeight:500,marginBottom:"1rem"}},"Nama caleg belum diatur. Silakan hubungi admin."),m(".grid",{style:{gridTemplateColumns:"repeat(auto-fit, minmax(12rem, 1fr))"}},this.kecamatanList.map(a=>m("article",{onclick:this.calegName?()=>this.selectKecamatan(a):null,style:Object.assign({},b,this.calegName?{}:{opacity:.5,pointerEvents:"none",cursor:"not-allowed"})},m("h3",{style:y},a.name)))),m("footer",{style:{paddingTop:"var(--spacing)"}},[t&&m("button",{style:{marginRight:"1rem"},onclick:()=>m.route.set("/app/admin")},"Ke Halaman Admin"),m("button",{class:"contrast",onclick:h},o.logout)])])}};var k={provinsiList:[],kabupatenList:[],selectedProvinsi:"",selectedKabupaten:"",loading:!1,provinsiLoading:!0,kabupatenLoading:!1,success:"",error:"",areaSet:!1,areaDisplay:"",showEdit:!1,editSecret:"",editSecretError:"",oninit(){this.provinsiLoading=!0,m.request({method:"GET",url:"/api/provinsi"}).then(e=>{this.provinsiList=e,this.provinsiLoading=!1,m.redraw();let t=localStorage.getItem("token"),a=t?{Authorization:`Bearer ${t}`}:{};m.request({method:"GET",url:"/api/area-setting",headers:a}).then(i=>{if(console.log("Fetched area setting:",i),i&&i.provinsi&&i.kabupatenKota){this.selectedProvinsi=i.provinsi,this.selectedKabupaten=i.kabupatenKota,this.areaSet=!0;let s=this.provinsiList.find(r=>r.code===i.provinsi);s?m.request({method:"POST",url:"/api/kabupatenkota",body:{provinsiCode:s.code},headers:{"Content-Type":"application/json"}}).then(r=>{this.kabupatenList=r;let n=this.kabupatenList.find(w=>w.code===i.kabupatenKota),d=s?s.name:i.provinsi,l=n?n.name:i.kabupatenKota;this.areaDisplay=`${d} / ${l}`,m.redraw()}):(this.areaDisplay=`${i.provinsi} / ${i.kabupatenKota}`,m.redraw())}else this.areaSet=!1})}).catch(()=>{this.provinsiLoading=!1,m.redraw()})},fetchKabupaten(){this.selectedProvinsi&&(this.kabupatenLoading=!0,console.log("Fetching kabupaten for provinsi:",this.selectedProvinsi),m.request({method:"POST",url:"/api/kabupatenkota",body:{provinsiCode:this.selectedProvinsi},headers:{"Content-Type":"application/json"}}).then(e=>{console.log("Fetched kabupaten list:",e),this.kabupatenList=e,this.kabupatenLoading=!1,m.redraw()}).catch(()=>{this.kabupatenList=[],this.kabupatenLoading=!1,m.redraw()}))},save(){this.loading=!0,this.success="",this.error="";let e=localStorage.getItem("token"),t=JSON.parse(localStorage.getItem("user")||"{}");console.log("[AREA SETTING] User from localStorage:",t);let a=e?{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}:{"Content-Type":"application/json"},i={provinsi:this.selectedProvinsi,kabupatenKota:this.selectedKabupaten,admin:t.id||t._id};console.log("[AREA SETTING] Sending POST body:",i),m.request({method:"POST",url:"/api/area-setting",body:i,headers:a}).then(()=>{this.loading=!1,this.success="",this.error="",this.showEdit=!1,this.editSecret="";let s=this.provinsiList.find(r=>r.code===this.selectedProvinsi);this.areaDisplay=`${s?s.name:this.selectedProvinsi} / ${this.kabupatenList.find(r=>r.code===this.selectedKabupaten)?.name||this.selectedKabupaten}`,this.areaSet=!0,m.redraw()}).catch(()=>{this.error=o.saveError||"Gagal menyimpan",this.loading=!1,m.redraw()})},view(e){let t=e.attrs.hasSubmissions||!1;return this.provinsiLoading||this.selectedProvinsi===""&&!this.areaSet?m("section",[m("p","Memuat...")]):this.areaSet&&!this.showEdit?m("section",[m("h3",o.areaSetting||"Pengaturan Area"),m("div",[m("strong",o.currentArea||"Area Saat Ini:")," ",this.areaDisplay?m("span",this.areaDisplay):m("span","memuat..")]),m("button",{onclick:()=>{this.showEdit=!0},disabled:t},o.editArea||"Ubah Area"),t&&m("p",{style:{fontSize:"0.8rem",fontStyle:"italic",marginTop:"0.5rem",color:"var(--pico-color-red-500)"}},"Pengaturan tidak dapat diubah karena sudah ada data suara yang masuk.")]):m("section",[m("h3",o.areaSetting||"Pengaturan Area"),m("form",{onsubmit:a=>{a.preventDefault(),this.save()}},[m("label",{for:"provinsi"},o.province||"Provinsi"),m("select",{id:"provinsi",onchange:a=>{this.selectedProvinsi=a.target.value,this.selectedKabupaten="",this.kabupatenList=[],this.selectedProvinsi&&this.fetchKabupaten(),m.redraw()},value:this.selectedProvinsi,disabled:this.provinsiLoading},[this.provinsiLoading?m("option",{value:""},"Memuat..."):[m("option",{value:""},o.selectProvince||"Pilih Provinsi"),this.provinsiList.map(a=>m("option",{value:a.code},a.name))]]),m("label",{for:"kabupaten"},o.kabupatenKota||"Kabupaten/Kota"),m("select",{id:"kabupaten",onchange:a=>{this.selectedKabupaten=a.target.value},value:this.selectedKabupaten,disabled:!this.selectedProvinsi||this.kabupatenLoading},[this.kabupatenLoading?m("option",{value:""},"Memuat..."):[m("option",{value:""},o.selectKabupaten||"Pilih Kabupaten/Kota"),this.kabupatenList.map(a=>m("option",{value:a.code},a.name))]]),m("button[type=submit]",{disabled:this.loading},o.save||"Simpan"),this.success&&m("div.success",this.success),this.error&&m("div.error",this.error)])])}};var S={caleg:"",showEdit:!1,editSecret:"",editSecretError:"",loading:!1,error:"",oninit(){let e=localStorage.getItem("token"),t=e?{Authorization:`Bearer ${e}`}:{};m.request({method:"GET",url:"/api/caleg",headers:t}).then(a=>{a&&a.name?this.caleg=a.name:this.showEdit=!0,m.redraw()})},save(e){this.loading=!0,this.error="";let t=localStorage.getItem("token"),a=t?{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}:{"Content-Type":"application/json"};m.request({method:"POST",url:"/api/caleg",body:{name:e},headers:a}).then(i=>{this.caleg=i.name,this.showEdit=!1,this.editSecret="",this.editSecretError="",this.loading=!1,m.redraw()}).catch(()=>{this.error=o.saveError||"Gagal menyimpan",this.loading=!1,m.redraw()})},view(e){let t=e.attrs.hasSubmissions||!1;return this.caleg&&!this.showEdit?m("section",[m("h3",o.calegSetting||"Caleg"),m("div",[m("strong",o.currentCaleg||"Caleg Saat Ini:")," ",this.caleg]),m("button",{onclick:()=>{this.showEdit=!0},disabled:t},o.editCaleg||"Ubah Caleg"),t&&m("p",{style:{fontSize:"0.8rem",fontStyle:"italic",marginTop:"0.5rem",color:"var(--pico-color-red-500)"}},"Pengaturan tidak dapat diubah karena sudah ada data suara yang masuk.")]):m("section",[m("h3",o.calegSetting||"Caleg"),m("form",{onsubmit:a=>{a.preventDefault();let i=a.target.elements.caleg.value;this.save(i)}},[m("label",{for:"caleg"},o.calegName||"Nama Caleg"),m("input[type=text][name=caleg][id=caleg][autocomplete=off]"),m("button[type=submit]",{disabled:this.loading},o.save||"Simpan"),this.error&&m("div.error",this.error)])])}};var P={currentView:"dashboard",unverifiedUsers:[],allSubmissions:[],voteSummary:{byKabupaten:{},byKecamatan:{},byDesa:{}},filters:{selectedKabupaten:"all",selectedKecamatan:"all",selectedDesa:"all"},availableOptions:{kabupaten:[],kecamatan:[],desa:[]},currentPage:1,itemsPerPage:20,totalPages:1,loading:{initial:!0,users:!1,submissions:!1,summary:!1},error:"",isMapModalOpen:!1,mapModalUrl:"",summaryFilterLevel:"all",summaryFilterKecamatan:"all",isDetailsModalOpen:!1,detailsModalTitle:"",submissionsForModal:[],isEditModalOpen:!1,editingSubmission:null,submissionLoadingStates:{},areaData:{kecamatanList:[],desaList:[]},oninit(){this.checkAdminAccess()},checkAdminAccess(){if(!localStorage.getItem("token")){m.route.set("/app/login");return}let t=JSON.parse(localStorage.getItem("user")||"{}");if(!t||t.role!=="admin"){m.route.set("/app/dashboard");return}this.loadDashboardData()},async loadDashboardData(){this.loading.initial=!0,this.error="",m.redraw();try{let[e,t,a]=await Promise.all([this.loadUnverifiedUsers(),this.loadSubmissions(),this.loadAreaData()]);this.unverifiedUsers=e||[],this.allSubmissions=t||[],this.areaData=a||{kecamatanList:[],desaList:[]},this.totalPages=Math.ceil(this.allSubmissions.length/this.itemsPerPage),this.calculateVoteSummary(this.allSubmissions)}catch(e){this.error="Gagal memuat data dashboard.",console.error("Error loading initial dashboard data:",e),e.response&&console.error("Response:",e.response),e.message&&console.error("Message:",e.message)}finally{this.loading.initial=!1,m.redraw()}},async refreshUsers(){this.loading.users=!0,m.redraw();try{this.unverifiedUsers=await this.loadUnverifiedUsers()}catch{this.error="Gagal memuat pengguna."}finally{this.loading.users=!1,m.redraw()}},async refreshSubmissionsAndSummary(){this.loading.submissions=!0,this.loading.summary=!0,m.redraw();try{this.allSubmissions=await this.loadSubmissions(),this.totalPages=Math.ceil(this.allSubmissions.length/this.itemsPerPage),this.calculateVoteSummary(this.allSubmissions)}catch{this.error="Gagal memuat data submission."}finally{this.loading.submissions=!1,this.loading.summary=!1,m.redraw()}},async loadAreaData(){try{let e=await m.request({method:"GET",url:"/api/area-setting",headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(e&&e.kabupatenKota)try{let[t,a]=await Promise.all([m.request({method:"POST",url:"/api/kecamatan",body:{kabupatenCode:e.kabupatenKota,provinsiCode:e.provinsi},headers:{"Content-Type":"application/json"}}),m.request({method:"POST",url:"/api/kelurahan",body:{kabupatenCode:e.kabupatenKota,provinsiCode:e.provinsi},headers:{"Content-Type":"application/json"}})]);return{kecamatanList:t,desaList:a}}catch(t){return console.warn("Failed to load kecamatan/desa:",t),{kecamatanList:[],desaList:[]}}}catch(e){console.error("Error loading area setting:",e)}return{kecamatanList:[],desaList:[]}},loadUnverifiedUsers(){return m.request({method:"POST",url:"/api/admin_unusers",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{}})},loadSubmissions(){return m.request({method:"POST",url:"/api/admin_subs",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{}})},_getResolvedAreaName(e,t){if(e==="kecamatan"){let a=t.kecamatanCode;if(!a)return t.district||"N/A";let i=this.areaData.kecamatanList.find(s=>s.code===a);return i?i.name:t.district||this.getKecamatanName(a)||a||"N/A"}if(e==="desa"){let a=t.kelurahanDesaCode;if(!a)return t.village||"N/A";let i=this.areaData.desaList.find(s=>s.code===a);return i?i.name:t.village||this.getDesaName(a)||a}return"N/A"},calculateVoteSummary(e){let t={},a={};e.forEach(r=>{let n=this._getResolvedAreaName("kecamatan",r),d=this._getResolvedAreaName("desa",r);t[n]||(t[n]={calegVotes:0,totalVotes:0,submissions:0,kecamatanName:n}),t[n].submissions+=1,r.status==="approved"&&(t[n].calegVotes+=parseInt(r.calegVotes)||0,t[n].totalVotes+=parseInt(r.totalVotes||r.votes)||0);let l=`${n}-${d}`;a[l]||(a[l]={calegVotes:0,totalVotes:0,submissions:0,kecamatanName:n,desaName:d}),a[l].submissions+=1,r.status==="approved"&&(a[l].calegVotes+=parseInt(r.calegVotes)||0,a[l].totalVotes+=parseInt(r.totalVotes||r.votes)||0)});let i=new Set(Object.keys(t)),s=new Map;Object.values(a).forEach(r=>{s.has(r.kecamatanName)||s.set(r.kecamatanName,new Set),s.get(r.kecamatanName).add(r.desaName)}),this.availableOptions={kecamatan:Array.from(i).sort(),desa:s},this.voteSummary={byKecamatan:t,byDesa:a},console.log("Vote summary calculated:",this.voteSummary),console.log("Available options:",this.availableOptions)},getKecamatanName(e){return{"010":"DENPASAR SELATAN","020":"DENPASAR UTARA","030":"DENPASAR BARAT","040":"DENPASAR TIMUR"}[e]},getDesaName(e){return{"001":"SIDAKARYA","002":"SANUR KAJA","003":"SANUR KAUH","004":"RENON","005":"SERANGAN","006":"RENON","007":"PANJER","008":"KESIMAN","009":"KESIMAN KERTALANGU","010":"KESIMAN PETILAN"}[e]},getFilteredVoteSummary(){let{selectedKecamatan:e,selectedDesa:t}=this.filters,a={},i={};return e==="all"?a={...this.voteSummary.byKecamatan}:a[e]=this.voteSummary.byKecamatan[e],Object.entries(this.voteSummary.byDesa).forEach(([s,r])=>{let n=e==="all"||r.kecamatanName===e,d=t==="all"||r.desaName===t;n&&d&&(i[s]=r)}),{byKecamatan:a,byDesa:i}},getAvailableDesa(){let e=this.filters.selectedKecamatan;if(e==="all"){let t=new Set;return this.availableOptions.desa.forEach(a=>{a.forEach(i=>t.add(i))}),Array.from(t).sort()}else{let t=this.availableOptions.desa.get(e);return t?Array.from(t).sort():[]}},onKecamatanChange(e){this.filters.selectedKecamatan=e,this.filters.selectedDesa="all",m.redraw()},onDesaChange(e){this.filters.selectedDesa=e,m.redraw()},openMapModal(e){if(!e||e.length!==2)return;let[t,a]=e;this.isMapModalOpen=!0,this.mapModalUrl=`https://maps.google.com/maps?q=${a},${t}&z=15&output=embed`,m.redraw()},closeMapModal(){this.isMapModalOpen=!1,this.mapModalUrl="",m.redraw()},renderMapModal(){return this.isMapModalOpen?m("dialog",{open:!0,onclick:()=>this.closeMapModal()},[m("article",{style:{padding:"0",maxWidth:"800px",width:"90vw"},onclick:e=>e.stopPropagation()},[m("header",{style:{padding:"0.5rem 1rem",display:"flex",justifyContent:"flex-end"}},m("a.close",{href:"#","aria-label":"Close",onclick:e=>{e.preventDefault(),this.closeMapModal()}})),m("div",{style:{padding:"0 1rem 1rem 1rem"}},m("iframe",{src:this.mapModalUrl,width:"100%",height:"500",style:{border:0,display:"block"},allowfullscreen:"",loading:"lazy",referrerpolicy:"no-referrer-when-downgrade"}))])]):null},renderStatsCards(){let e=this.getFilteredVoteSummary(),t=Object.values(e.byKecamatan).reduce((i,s)=>i+s.calegVotes,0),a=Object.values(e.byKecamatan).reduce((i,s)=>i+s.totalVotes,0);return m("section.grid",[m("article",[m("h4","Pengguna Belum Terverifikasi"),m("h2",this.unverifiedUsers.length)]),m("article",[m("h4","Total Submission"),m("h2",this.allSubmissions.length)]),m("article",[m("h4","Total Suara Caleg"),m("h2",{style:{color:"#2563eb"}},t.toLocaleString("id-ID"))]),m("article",[m("h4","Total Suara Sah"),m("h2",{style:{color:"#059669"}},a.toLocaleString("id-ID"))])])},renderUnverifiedUsersSection(){let e=this.unverifiedUsers.filter(t=>t.isVerified===!1);return m("section",[m("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"}},[m("h4",{style:{margin:0}},"Pengguna Belum Terverifikasi"),m("button",{class:"outline secondary",style:{margin:0,padding:"0.25rem 0.75rem"},onclick:()=>this.refreshUsers(),"aria-busy":this.loading.users},this.loading.users?m("div",{"aria-busy":"true"},"Memuat data .."):"\u{1F504} Refresh")]),e.length===0?m("p","Tidak ada pengguna yang perlu diverifikasi"):m("table",[m("thead",m("tr",[m("th","Nama"),m("th","No. HP"),m("th","Tanggal Daftar"),m("th","Aksi")])),m("tbody",e.map(t=>m("tr",[m("td",t.fullName),m("td",t.phoneNumber),m("td",new Date(t.createdAt).toLocaleDateString("id-ID")),m("td",m("button",{onclick:()=>this.verifyUser(t._id)},"Verifikasi"))])))])])},renderSubmissionsSection(){return m("section",[m("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"}},[m("h4",{style:{margin:0}},"Submission Terbaru"),m("button",{class:"outline secondary",style:{margin:0,padding:"0.25rem 0.75rem"},onclick:()=>this.refreshSubmissionsAndSummary(),"aria-busy":this.loading.submissions},this.loading.submissions?m("div",{"aria-busy":"true"},"Memuat data .."):"\u{1F504} Refresh")]),this.allSubmissions.length===0?m("p","Belum ada submission"):m("table",[m("thead",m("tr",[m("th","Volunteer"),m("th","TPS"),m("th","Kecamatan"),m("th","Desa/Kelurahan"),m("th","Suara"),m("th","Foto"),m("th","GPS"),m("th","Status"),m("th","Aksi")])),m("tbody",this.getPaginatedSubmissions().map(e=>{let t=this._getResolvedAreaName("kecamatan",e),a=this._getResolvedAreaName("desa",e),i=this.submissionLoadingStates[e._id]?.approving,s=this.submissionLoadingStates[e._id]?.flagging;return m("tr",[m("td",e.volunteerDisplayName||"Unknown"),m("td",e.tps||e.tpsNumber),m("td",t),m("td",a),m("td",`${e.calegVotes||""}/${e.totalVotes||e.votes||""}`),m("td",e.hasPhoto?m("button",{onclick:()=>this.viewPhoto(e._id),style:{fontSize:"12px",padding:"4px 8px",background:"#007bff",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"}},"Lihat"):m("span",{style:{color:"#999"}},"\u274C")),m("td",e.location&&e.location.coordinates&&e.location.coordinates.length===2?m("button",{onclick:()=>this.openMapModal(e.location.coordinates),title:"Lihat Peta",class:"outline secondary",style:{margin:0,padding:"0.25rem 0.5rem",fontSize:"1.1rem",lineHeight:1,display:"flex",alignItems:"center",justifyContent:"center"}},"\u{1F4CD}"):m("span",{style:{color:"#999"}},"\u274C")),m("td",e.status||"-"),m("td",[m("button",{onclick:()=>this.openEditModal(e._id),class:"outline secondary",style:{marginRight:"0.5rem",padding:"0.25rem 0.5rem"},title:"Edit"},"\u270F\uFE0F"),e.status!=="approved"&&m("button",{onclick:()=>this.approveSubmission(e._id),style:{marginRight:"0.5rem"},disabled:i||s,"aria-busy":i?"true":null},i?"Memproses...":"Setujui"),e.status!=="flagged"&&m("button",{onclick:()=>this.flagSubmission(e._id),class:"secondary",style:{marginLeft:"0.5rem"},disabled:s||i,"aria-busy":s?"true":null},s?"Memproses...":"Tandai")])])}))]),this.renderPaginationControls()])},async openEditModal(e){this.editingSubmissionId=e,this.editingSubmission=null,(this.areaData.kecamatanList.length===0||this.areaData.desaList.length===0)&&await this.loadAreaData();try{let t=await m.request({method:"POST",url:"/api/submission_detail",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{id:e}});console.log("AdminPanel: Fetched submission data:",t),console.log("AdminPanel: Available areaData:",this.areaData),this.editingSubmission=t}catch(t){console.error("Error fetching submission data:",t),this.error="Failed to load submission data for editing"}this.isEditModalOpen=!0,m.redraw()},closeEditModal(){this.isEditModalOpen=!1,this.editingSubmissionId=null,m.redraw()},renderEditModal(){return this.isEditModalOpen?m("dialog",{open:!0},[m("article",[m("header",m("a.close",{href:"#","aria-label":"Close",onclick:e=>{e.preventDefault(),this.closeEditModal()}})),this.editingSubmission?m(c,{submission:this.editingSubmission,areaData:this.areaData,onsuccess:()=>{this.closeEditModal(),this.refreshSubmissionsAndSummary()}}):m("div",{"aria-busy":"true"},"Memuat data submission...")])]):null},viewPhoto(e){window.open(`/api/photo/${e}`,"_blank")},openDetailsModal(e,t){this.isDetailsModalOpen=!0;let a=[];if(e==="all")this.detailsModalTitle="Semua Submission",a=this.allSubmissions;else if(e==="kecamatan")this.detailsModalTitle=`Submission untuk Kecamatan: ${t}`,a=this.allSubmissions.filter(i=>(this.areaData.kecamatanList.find(s=>s.code===i.kecamatanCode)?.name||i.district||i.kecamatanCode)===t);else if(e==="desa"){let{kecamatanName:i,desaName:s}=t;this.detailsModalTitle=`Submission untuk Desa: ${s} (Kec. ${i})`,a=this.allSubmissions.filter(r=>{let n=this.areaData.kecamatanList.find(l=>l.code===r.kecamatanCode)?.name||r.district||r.kecamatanCode,d=this.areaData.desaList.find(l=>l.code===r.kelurahanDesaCode)?.name||r.village||r.kelurahanDesaCode;return n===i&&d===s})}this.submissionsForModal=a,m.redraw()},closeDetailsModal(){this.isDetailsModalOpen=!1,this.detailsModalTitle="",this.submissionsForModal=[],m.redraw()},renderDetailsModal(){return this.isDetailsModalOpen?m("dialog",{open:!0},[m("article",{style:{maxWidth:"95vw",width:"1200px"}},[m("header",[m("h5",this.detailsModalTitle),m("a.close",{href:"#","aria-label":"Close",onclick:e=>{e.preventDefault(),this.closeDetailsModal()}})]),m("div",{style:{overflowX:"auto"}},m("table",[m("thead",m("tr",[m("th","Volunteer"),m("th","TPS"),m("th","Kecamatan"),m("th","Desa/Kelurahan"),m("th","Suara"),m("th","Foto"),m("th","GPS"),m("th","Status"),m("th","Aksi")])),m("tbody",this.submissionsForModal.map(e=>{let t=this.areaData.kecamatanList.find(r=>r.code===e.kecamatanCode)?.name||e.district||e.kecamatanCode||"N/A",a=this.areaData.desaList.find(r=>r.code===e.kelurahanDesaCode)?.name||e.village||e.kelurahanDesaCode||"N/A",i=this.submissionLoadingStates[e._id]?.approving,s=this.submissionLoadingStates[e._id]?.flagging;return m("tr",[m("td",e.volunteerDisplayName||"Unknown"),m("td",e.tps||e.tpsNumber),m("td",t),m("td",a),m("td",`${e.calegVotes||""}/${e.totalVotes||e.votes||""}`),m("td",e.hasPhoto?m("button",{onclick:()=>this.viewPhoto(e._id)},"Lihat"):"\u274C"),m("td",e.location&&e.location.coordinates?m("button",{onclick:()=>this.openMapModal(e.location.coordinates),class:"outline secondary",style:{padding:"0.25rem 0.5rem"}},"\u{1F4CD}"):"\u274C"),m("td",e.status||"-"),m("td",[e.status!=="approved"&&m("button",{onclick:()=>this.approveSubmission(e._id),style:{marginRight:"0.5rem"},disabled:i||s,"aria-busy":i?"true":null},i?"Memproses...":"Setujui"),e.status!=="flagged"&&m("button",{onclick:()=>this.flagSubmission(e._id),class:"secondary",style:{marginLeft:"0.5rem"},disabled:s||i,"aria-busy":s?"true":null},s?"Memproses...":"Tandai")])])}))]))])]):null},renderSummarySection(){let e=Object.values(this.voteSummary.byKecamatan),t=Object.values(this.voteSummary.byDesa),a=[],i=["Area","Total Submission","Total Suara Sah","Total Suara Caleg","Aksi"];if(this.summaryFilterLevel==="all"){let s=this.allSubmissions.length,r=e.reduce((d,l)=>d+l.totalVotes,0),n=e.reduce((d,l)=>d+l.calegVotes,0);a.push({area:"Semua Area",submissions:s,totalVotes:r,calegVotes:n,filterType:"all",identifier:"all"})}else this.summaryFilterLevel==="kecamatan"?a=e.map(s=>({area:s.kecamatanName,submissions:s.submissions,totalVotes:s.totalVotes,calegVotes:s.calegVotes,filterType:"kecamatan",identifier:s.kecamatanName})):this.summaryFilterLevel==="desa"&&(a=(this.summaryFilterKecamatan==="all"?t:t.filter(r=>r.kecamatanName===this.summaryFilterKecamatan)).map(r=>({area:this.summaryFilterKecamatan==="all"?`${r.desaName} (Kec. ${r.kecamatanName})`:r.desaName,submissions:r.submissions,totalVotes:r.totalVotes,calegVotes:r.calegVotes,filterType:"desa",identifier:{kecamatanName:r.kecamatanName,desaName:r.desaName}})));return m("section",{style:{marginTop:"2rem",borderTop:"1px solid var(--pico-muted-border-color)",paddingTop:"1.5rem"}},[m("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"}},[m("h4",{style:{margin:0}},"Ringkasan Suara Berdasarkan Area"),m("button",{class:"outline secondary",style:{margin:0,padding:"0.25rem 0.75rem"},onclick:()=>this.refreshSubmissionsAndSummary(),"aria-busy":this.loading.summary},this.loading.summary?m("div",{"aria-busy":"true"},"Memuat data .."):"\u{1F504} Refresh")]),m("div.grid",[m("div",[m("label",{for:"summary-level"},"Tampilkan Berdasarkan"),m("select#summary-level",{onchange:s=>{this.summaryFilterLevel=s.target.value,this.summaryFilterKecamatan="all"}},[m("option",{value:"all"},"Semua"),m("option",{value:"kecamatan"},"Kecamatan"),m("option",{value:"desa"},"Desa/Kelurahan")])]),this.summaryFilterLevel==="desa"&&m("div",[m("label",{for:"summary-kecamatan"},"Pilih Kecamatan"),m("select#summary-kecamatan",{onchange:s=>this.summaryFilterKecamatan=s.target.value},[m("option",{value:"all"},"Semua Kecamatan"),...this.availableOptions.kecamatan.map(s=>m("option",{value:s},s))])])]),m("table",{style:{marginTop:"1rem"}},[m("thead",m("tr",i.map(s=>m("th",s)))),m("tbody",a.map(s=>m("tr",[m("td",s.area),m("td",s.submissions),m("td",s.totalVotes.toLocaleString("id-ID")),m("td",s.calegVotes.toLocaleString("id-ID")),m("td",m("button",{onclick:()=>this.openDetailsModal(s.filterType,s.identifier)},"Lihat Detail"))])))])])},getPaginatedSubmissions(){let e=(this.currentPage-1)*this.itemsPerPage,t=e+this.itemsPerPage;return this.allSubmissions.slice(e,t)},renderPaginationControls(){return this.totalPages<=1?null:m(".pagination-controls",{style:{marginTop:"1rem",textAlign:"center"}},[m("button",{onclick:()=>this.currentPage--,disabled:this.currentPage===1},"\u2039 Sebelumnya"),m("span",{style:{margin:"0 1rem",verticalAlign:"middle"}},`Halaman ${this.currentPage} dari ${this.totalPages}`),m("button",{onclick:()=>this.currentPage++,disabled:this.currentPage>=this.totalPages},"Berikutnya \u203A")])},renderDashboard(){return[m("h3","Admin Dashboard"),this.error&&m("div.error",this.error),this.renderStatsCards(),this.renderUnverifiedUsersSection(),this.renderSubmissionsSection(),this.renderEditModal(),this.renderDetailsModal(),this.renderSummarySection(),this.renderMapModal()]},verifyUser(e){return m.request({method:"POST",url:"/api/verify_user",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{id:e}}).then(()=>{this.unverifiedUsers=this.unverifiedUsers.filter(t=>t._id!==e),m.redraw()}).catch(t=>{console.error("Error verifying user:",t),this.error="Failed to verify user"})},unverifyVolunteer(e){return m.request({method:"POST",url:"/api/unverify_volunteer",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{id:e}}).then(()=>{this.refreshUsers&&this.refreshUsers(),m.redraw()}).catch(t=>{console.error("Error unverifying volunteer:",t),this.error="Failed to unverify volunteer"})},approveSubmission(e){return m.request({method:"POST",url:"/api/approve",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{id:e}})},flagSubmission(e){return m.request({method:"POST",url:"/api/flag",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:{id:e}})},renderNavigation(){return m("nav",[m("ul",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},[m("div",{style:{display:"flex",gap:"0.5rem"}},[m("li",m("button",{class:this.currentView==="dashboard"?"active":"",onclick:()=>this.currentView="dashboard"},"Dashboard")),m("li",m("button",{class:this.currentView==="area-setting"?"active":"",onclick:()=>this.currentView="area-setting"},"Pengaturan Area")),m("li",m("button",{class:this.currentView==="caleg-setting"?"active":"",onclick:()=>this.currentView="caleg-setting"},"Pengaturan Caleg")),m("li",m("button",{onclick:()=>m.route.set("/dashboard")},"Menu Relawan"))]),m("li",m("button",{style:{background:"#dc2626",color:"#fff",border:"none",marginLeft:"1rem",padding:"0.5rem 1.2rem",borderRadius:"4px",fontWeight:600,cursor:"pointer"},onclick:()=>{localStorage.removeItem("token"),localStorage.removeItem("user"),m.route.set("/app/login")}},"Logout"))])])},view(){return this.loading.initial?m("div.container-fluid",{style:{textAlign:"center",marginTop:"5rem"}},m("span",{"aria-busy":"true"},"Memuat...")):m("div.container-fluid",[m("h2","Admin Panel"),this.renderNavigation(),this.currentView==="dashboard"?this.renderDashboard():this.currentView==="area-setting"?m(k):this.currentView==="caleg-setting"?m(S):m("div","Unknown view")])}};var p=()=>!!localStorage.getItem("token");m.route.prefix="#!";m.route(document.body,"/app/login",{"/app/login":{render:()=>m(g)},"/app/register":{render:()=>m(f)},"/app/dashboard":{onmatch:()=>p()?void 0:m.route.set("/app/login"),render:()=>m(v)},"/app/submit":{onmatch:()=>p()?void 0:m.route.set("/app/login"),render:()=>m(c)},"/app/submit/:id":{onmatch:()=>p()?void 0:m.route.set("/app/login"),render:e=>m(c,{id:e.attrs.id})},"/app/admin":{render:()=>m(P)}});
